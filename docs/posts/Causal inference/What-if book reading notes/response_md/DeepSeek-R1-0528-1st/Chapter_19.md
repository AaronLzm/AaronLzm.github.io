---
title: Chapter_19
category: Causal inference
tags: [DeepSeek-R1-0528-1st,response_md]

---
<think>
我们正在处理《因果推断：What If》第19章“时变处理”的内容。本章介绍了时变处理的核心概念、识别条件以及相关方法。以下将严格按照章节结构提炼技术要点和细节要点，并确保不遗漏任何重要内容。对于数学公式，使用Markdown的LaTeX格式。

### 章节结构
1. **19.1 时变处理的因果效应**
2. **19.2 处理策略**
3. **19.3 序贯随机化实验**
4. **19.4 序贯可交换性**
5. **19.5 部分处理策略下的可识别性**
6. **19.6 时变混杂和时变混杂因子**

### 技术要点总结

#### 19.1 时变处理的因果效应
- **核心问题**：时变处理（如药物治疗、生活习惯）在不同时间点取值可能不同，传统固定处理的因果效应定义（如$E[Y^{a=1}] - E[Y^{a=0}]$）不再适用。
- **关键难点**：时变处理的因果效应需考虑整个处理历史（treatment history），而非单时间点干预。
- **符号定义**：
  - $A_k$：在时间$k$的处理（二值变量，如是否接受抗病毒治疗）。
  - $\bar{A}_k = (A_0, A_1, \dots, A_k)$：从时间0到$k$的处理历史。
  - $\bar{A} = \bar{A}_K$：整个随访期间的处理历史（$K=59$个月）。
  - 示例：持续治疗记为$\bar{A} = \bar{1} = (1,1,\dots,1)$，从不治疗记为$\bar{A} = \bar{0} = (0,0,\dots,0)$。
- **因果效应定义**：时变处理的因果效应需通过对比不同处理策略（treatment strategies）下的反事实结果均值（如$E[Y^{\bar{a}}] - E[Y^{\bar{a}'}]$），而非单时间点对比（如$E[Y^{a_k=1}] - E[Y^{a_k=0}]$）。

#### 19.2 处理策略
- **处理策略定义**：规则（或称计划、政策）用于在每个时间$k$分配处理。分为：
  - **静态策略（static strategy）**：处理分配仅依赖时间，不依赖协变量（如“始终治疗”$\bar{a}=\bar{1}$，“从不治疗”$\bar{a}=\bar{0}$）。
  - **动态策略（dynamic strategy）**：处理分配依赖时变协变量（如“当CD4细胞计数低时开始治疗”）。
- **因果效应多样性**：时变处理的因果效应非唯一，取决于所对比的策略对（如“始终治疗” vs. “从不治疗”，或“交替治疗” vs. “首月不治疗”）。
- **策略数量**：二值处理下，静态策略有$2^K$种，但动态策略更多（依赖协变量演化）。
- **形式化定义**（Fine Point 19.1）：
  - 确定性策略：$g_k(\bar{a}_{k-1}, \bar{l}_k)$指定个体在$k$时刻的处理值。
  - 随机策略：分配处理值的概率（静态或动态）。
  - 最优策略：最大化$E[Y^g]$的确定性策略（通常因毒性反应需动态调整）。

#### 19.3 序贯随机化实验
- **实验设计**：处理$A_k$在每时间$k$随机分配，概率依赖过去处理史$\bar{A}_{k-1}$和协变量史$\bar{L}_k$。
- **因果图表示**（图19.1–19.3）：
  - 图19.1：无混杂（处理仅依赖前处理，无$L_k$或$U_k$影响）。
  - 图19.2：有测混杂（处理依赖$\bar{L}_k$，无$U_k$影响）。
  - 图19.3：未测混杂（处理依赖$U_k$）。
- **可识别性**：
  - 图19.1或19.2：可估计所有策略$g$的$E[Y^g]$（无未测混杂）。
  - 图19.3：不可识别（存在未测混杂）。
- **观察性研究**：通常对应图19.2或19.3，需假设无未测混杂（图19.2）才能识别效应。

#### 19.4 序贯可交换性
- **核心条件**：推广时间固定处理的交换性$Y^a \perp\!\!\!\perp A \mid L$至时变场景。
- **序贯可交换性定义**：
  - 对任意策略$g$，满足：
    $$
    Y^g \perp\!\!\!\perp A_k \mid \bar{A}_{k-1} = g(\bar{A}_{k-2}, \bar{L}_{k-1}), \bar{L}_k \quad \text{for all } k = 0,1,\dots,K
    $$
  - 含义：在给定过去处理史和协变量史下，当前处理分配与反事实结果独立。
- **其他条件**：
  - **正性**（Technical Point 19.2）：对所有可能历史和策略兼容处理，处理概率非零：
    $$
    f_{\bar{A}_{k-1},\bar{L}_k}(\bar{a}_{k-1},\bar{l}_k) \neq 0 \implies f_{A_k \mid \bar{A}_{k-1},\bar{L}_k}(a_k \mid \bar{a}_{k-1}, \bar{l}_k) > 0
    $$
  - **一致性**（Technical Point 19.2）：若实际处理与策略一致，则观测结果等于反事实结果：
    - 静态策略：$A = \bar{a} \implies Y = Y^{\bar{a}}$。
    - 动态策略：$A_k = g_k(\bar{A}_{k-1}, \bar{L}_k) \text{ for all } k \implies Y = Y^g$。
- **可识别性结论**：若序贯可交换性、正性、一致性成立，则$E[Y^g]$可通过g-方法（g-formula、IP加权、g-估计）识别。

#### 19.5 部分处理策略下的可识别性
- **图形化检验**：使用SWIGs（单例干预图）检查可识别性。
- **关键概念**：
  - **静态序贯可交换性**：仅对静态策略$\bar{a}$成立：
    $$
    Y^{\bar{a}} \perp\!\!\!\perp A_k \mid \bar{A}_{k-1} = \bar{a}_{k-1}, \bar{L}_k
    $$
    可识别静态策略效应，但动态策略可能不可识别。
  - **动态策略可识别性**：依赖因果图结构（图19.5 vs. 19.6）：
    - 图19.5（无$W_0$）：可识别所有策略（图19.7）和动态策略（图19.9）。
    - 图19.6（有$W_0$）：仅可识别静态策略（图19.8），动态策略因路径$A_0 \leftarrow W_0 \rightarrow L^g_1 \rightarrow Y^g$未阻断而不可识别（图19.10）。
- **示例**：图19.11（含$L_1 \rightarrow Y$）中，无任何策略可识别。

#### 19.6 时变混杂和时变混杂因子
- **时变混杂定义**：变量$L_k$同时受前处理影响，且与未来处理和结局相关，需调整以阻断后门路径。
- **混杂源**：实际混杂可能源于未测变量$U_k$，但$L_k$作为代理混杂因子。
- **调整要求**：为控制时变混杂，需测量整个协变量史$\bar{L}_k$。
- **挑战**：无法实证验证是否所有混杂已测量（图19.2 vs. 图19.3）。
- **Fine Point 19.3**：
  - 若$E[Y^{\bar{a}} \mid L_0] \neq E[Y \mid \bar{A} = \bar{a}, L_0]$，则存在时变混杂。
  - 无时变混杂的充分条件：无条件序贯可交换性$Y^{\bar{a}} \perp\!\!\!\perp A_k \mid \bar{A}_{k-1} = \bar{a}_{k-1}$（如图19.1的简化图）。

### 结论
- 时变处理的因果效应需通过对比处理策略定义，而非单时间点干预。
- 序贯可交换性是识别核心条件，需无未测混杂、正性、和一致性成立。
- 可识别性依赖因果图结构：静态策略可识别性较动态策略更易满足。
- 时变混杂需调整整个协变量史，但标准方法可能偏倚，需用g-方法（下章详述）。

> 注意：图像内容（如因果图）未在文本中详述，但关键结构已通过引用（如图19.1–19.12）和文字描述覆盖。数学公式严格按LaTeX格式书写。
</think>
### 第19章：时变处理（TIME-VARYING TREATMENTS）总结

#### **19.1 时变处理的因果效应**
- **核心问题**：传统固定处理（time-fixed treatments）的因果效应定义（如 $E[Y^{a=1}] - E[Y^{a=0}]$）不适用于时变处理（time-varying treatments），因处理状态随时间动态变化。
- **关键定义**：
  - $A_k$：时间点 $k$ 的二值处理变量（如抗病毒治疗：$A_k=1$ 治疗，$A_k=0$ 不治疗）。
  - $\bar{A}_k = (A_0, A_1, \dots, A_k)$：从时间 $0$ 到 $k$ 的处理历史（treatment history）。
  - $\bar{A} = \bar{A}_K$：整个随访期（$K=59$ 个月）的处理历史。
  - 反事实结果 $Y^{\bar{a}}$：遵循策略 $\bar{a}$ 的结局（如持续治疗 $\bar{a}=\bar{1}$，从不治疗 $\bar{a}=\bar{0}$）。
- **技术难点**：  
  时变处理的因果效应需定义为策略对比（如 $E[Y^{\bar{a}}] - E[Y^{\bar{a}'}]$），而非单时间点对比（如 $E[Y^{a_k=1}] - E[Y^{a_k=0}]$ 仅量化 $A_k$ 的瞬时效应）。

---

#### **19.2 处理策略（Treatment Strategies）**
- **策略类型**：
  - **静态策略（Static strategy）**：处理分配仅依赖时间，不依赖协变量（如 $\bar{a}=(1,0,1,\dots)$）。
  - **动态策略（Dynamic strategy）**：处理分配依赖时变协变量 $\bar{L}_k$（如“当 $L_k$（CD4计数）<阈值时治疗”）。
  - **随机策略（Random strategy）**：分配处理值概率（静态或动态）。
- **因果效应定义**：  
  时变处理的因果效应非唯一，需指定对比的策略对（如“始终治疗 vs. 从不治疗”或“动态策略 vs. 静态策略”）。
- **数学表达**：  
  - 最优策略：最大化 $E[Y^g]$ 的确定性策略 $g$（通常为动态策略）。
  - 策略数量：二值处理下，静态策略有 $2^K$ 种，动态策略更多。

---

#### **19.3 序贯随机化实验（Sequentially Randomized Experiments）**
- **设计**：在每时刻 $k$，$A_k$ 以依赖 $(\bar{A}_{k-1}, \bar{L}_k)$ 的概率随机分配。
- **因果图分类**（关键图示：图19.1–19.3）：
  - **图19.1**：无混杂（$A_k$ 仅依赖 $\bar{A}_{k-1}$，无 $L_k$ 或 $U_k$ 影响）。
  - **图19.2**：有测混杂（$A_k$ 依赖 $\bar{L}_k$，无 $U_k$ 影响）。
  - **图19.3**：未测混杂（$A_k$ 依赖 $U_k$）。
- **可识别性**：
  - 图19.1或19.2：可估计所有策略 $g$ 的 $E[Y^g]$。
  - 图19.3：不可识别（存在未测混杂）。

---

#### **19.4 序贯可交换性（Sequential Exchangeability）**
- **核心条件**：推广时间固定处理的交换性 $Y^a \perp\!\!\!\perp A \mid L$ 至时变场景：
  $$
  Y^g \perp\!\!\!\perp A_k \mid \bar{A}_{k-1} = g(\bar{A}_{k-2}, \bar{L}_{k-1}), \bar{L}_k \quad \forall k=0,1,\dots,K
  $$
- **辅助条件**：
  - **正性（Positivity）**：  
    $f_{\bar{A}_{k-1},\bar{L}_k}(\bar{a}_{k-1},\bar{l}_k) \neq 0 \implies f_{A_k \mid \bar{A}_{k-1},\bar{L}_k}(a_k \mid \bar{a}_{k-1}, \bar{l}_k) > 0$
  - **一致性（Consistency）**：  
    - 静态策略：$A = \bar{a} \implies Y = Y^{\bar{a}}$  
    - 动态策略：$A_k = g_k(\bar{A}_{k-1}, \bar{L}_k) \ \forall k \implies Y = Y^g$
- **可识别性结论**：若序贯可交换性、正性、一致性成立，则 $E[Y^g]$ 可通过 g-方法（g-formula/IP加权/g-估计）识别。

---

#### **19.5 部分策略下的可识别性（Identifiability Under Subsets of Strategies）**
- **图形化检验**：使用 SWIGs（单例干预图）验证可识别性。
- **关键概念**：
  - **静态序贯可交换性**（较弱条件）：  
    $$
    Y^{\bar{a}} \perp\!\!\!\perp A_k \mid \bar{A}_{k-1} = \bar{a}_{k-1}, \bar{L}_k
    $$
    仅保证静态策略 $E[Y^{\bar{a}}]$ 可识别。
  - **动态策略可识别性**：依赖因果图结构：
    - **图19.5**（无 $W_0$）：所有策略可识别（图19.7, 19.9）。
    - **图19.6**（有 $W_0$）：仅静态策略可识别（图19.8），动态策略因路径 $A_0 \leftarrow W_0 \rightarrow L^g_1 \rightarrow Y^g$ 未阻断而不可识别（图19.10）。
- **示例**：图19.11（含 $L_1 \rightarrow Y$）中，无任何策略可识别。

---

#### **19.6 时变混杂（Time-Varying Confounding）**
- **定义**：变量 $L_k$ 同时受前处理影响，且与未来处理和结局相关，需调整以阻断后门路径。
- **混杂源**：实际混杂常源于未测变量 $U_k$，但 $L_k$ 作为代理混杂因子。
- **调整要求**：需测量整个协变量史 $\bar{L}_k$。
- **挑战**：无法实证验证是否所有混杂已测量（图19.2 vs. 图19.3）。
- **Fine Point 19.3**：  
  - 时变混杂存在 $\iff E[Y^{\bar{a}} \mid L_0] \neq E[Y \mid \bar{A} = \bar{a}, L_0]$。  
---

### **结论**
1. **因果效应定义**：时变处理的因果效应需通过处理策略对比定义（如 $E[Y^{\bar{a}}] - E[Y^{\bar{a}'}]$），且效应非唯一。
2. **识别核心**：序贯可交换性 + 正性 + 一致性是识别 $E[Y^g]$ 的基础。
3. **可识别性依赖结构**：
   - 静态策略可识别性较动态策略更易满足。
   - 未测混杂（如 $U_k$ 或 $W_0$）会破坏可识别性。
4. **时变混杂调整**：需测量 $\bar{L}_k$，但标准方法可能偏倚，需用 g-方法（第21章）。

> **注**：所有数学公式严格按 LaTeX 格式书写，技术术语保留英文以确保准确性。