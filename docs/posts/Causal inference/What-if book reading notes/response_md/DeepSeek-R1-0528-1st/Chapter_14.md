---
date: 2025-09-17 11:19:05
title: Chapter_14
category: Causal inference
tags: [DeepSeek-R1-0528-1st,response_md]

---
<think>
我们正在处理《因果推断：What If》第14章的内容，主题是“结构嵌套模型的G估计”。我将严格按照要求，提炼所有技术重点和细节要点，保留数学公式的LaTeX格式，并使用中文总结，同时保留英文术语。

### 章节结构分析
本章包含以下子章节：
- 14.1 因果问题回顾
- 14.2 可交换性再探
- 14.3 结构嵌套均值模型
- 14.4 秩保持
- 14.5 G估计
- 14.6 具有两个或更多参数的结构嵌套模型
以及技术点（Technical Point）和精细点（Fine Point）。

### 核心内容提炼

#### 14.1 因果问题回顾
- **技术重点**：使用NHEFS数据估计戒烟（处理A）对体重增加（结果Y）的平均因果效应。目标量是条件平均因果效应：$E[Y^{a=1,c=0}|L] - E[Y^{a=0,c=0}|L]$，其中$L$是混杂变量集合（性别、年龄等）。
- **细节要点**：
  - 当关注子群体（如特定年龄层）的效应时，可使用带乘积项的边际结构模型（第12章）或仅针对该子群体的标准化（第13章）。
  - 若数据量极大，可将总体划分为非重叠的$L$ strata，并在每个stratum内估计因果效应。

#### 14.2 可交换性再探
- **技术重点**：条件可交换性$Y^a \perp\!\!\!\perp A | L$的等价定义为：
  $$
  \text{Pr}[A=1 | Y^{a=0}, L] = \text{Pr}[A=1 | L]
  $$
- **细节要点**：
  - 此定义将用于后续G估计：若可交换性成立，则反事实结果$Y^{a=0}$不应预测处理分配$A$（给定$L$）。
  - 提出参数化logistic模型：
  $$
  \text{logit Pr}[A=1 | Y^{a=0}, L] = \alpha_0 + \alpha_1 Y^{a=0} + \alpha_2 L
  $$
  其中$\alpha_1 = 0$是可交换性成立的标志。

#### 14.3 结构嵌套均值模型
- **技术重点**：结构嵌套均值模型（SNMM）定义为：
  $$
  E[Y^a - Y^{a=0} | A=a, L] = \beta_1 a + \beta_2 a L
  $$
- **细节要点**：
  - $\beta_1, \beta_2$量化$A$对$Y$在$(A,L)$层内的平均因果效应。
  - 与参数化g公式不同，SNMM是半参数模型：不指定截距$\beta_0$和$L$的主效应$\beta_3 L$，故更稳健。
  - 存在删失时，需先用IP权重（$W^C = 1/\text{Pr}[C=0|L,A]$）调整选择偏倚，再应用G估计。
- **精细点14.1**：比较边际结构模型（MSM）与SNMM：
  - 半参数MSM：$E[Y^a - Y^{a=0}|V] = \beta_1 a + \beta_2 a V$，仅指定处理效应，不指定$E[Y^{a=0}|V]$。
  - 当$V \subset L$且使用IP权重$SW^A(V)$时，半参数MSM等价于SNMM。
- **技术点14.1**：乘性SNMM（用于正值结局）：
  $$
  \log \left( \frac{E[Y^a | A=a, L]}{E[Y^{a=0} | A=a, L]} \right) = \beta_1 a + \beta_2 a L
  $$

#### 14.4 秩保持
- **技术重点**：加性秩保持结构模型假设个体因果效应恒定：
  $$
  Y_i^a - Y_i^{a=0} = \psi_1 a + \psi_2 a L_i \quad \forall i
  $$
- **细节要点**：
  - 秩保持不现实（个体效应存在异质性），但引入它是为了简化G估计的理解。
  - 实际SNMM不要求秩保持，仅估计层内平均因果效应（非个体效应）。

#### 14.5 G估计
- **技术重点**：基于秩保持模型$Y^{a=0} = Y - \psi_1 A$，通过搜索$\psi_1$使得$H(\psi^\dagger) = Y - \psi^\dagger A$满足：
  $$
  \alpha_1 = 0 \quad \text{in} \quad \text{logit Pr}[A=1 | H(\psi^\dagger), L] = \alpha_0 + \alpha_1 H(\psi^\dagger) + \alpha_2 L
  $$
- **细节要点**：
  - 步骤：
    1. 对候选值$\psi^\dagger$计算$H(\psi^\dagger)$。
    2. 拟合加权logistic模型（含IP权重$W^C$调整删失），检验$\alpha_1=0$。
    3. 选择使$\alpha_1$最接近0的$\psi^\dagger$作为估计$\hat{\psi}_1$。
  - 置信区间：通过假设检验反转，找到所有满足$p>0.05$的$\psi^\dagger$集合。
  - 实际应用中，G估计对非秩保持模型仍一致估计$\beta_1$（只要平均效应正确指定）。
- **精细点14.2**：未测量混杂的敏感性分析：
  - 若可交换性不成立（$\alpha_1 \neq 0$），可假设$\alpha_1$的取值并重复G估计，观察估计值变化。

#### 14.6 具有两个或更多参数的结构嵌套模型
- **技术重点**：当SNMM含乘积项（如$E[Y^a - Y^{a=0}|A=a,L] = \beta_1 a + \beta_2 a V$）时：
  - 需在二维空间搜索$(\beta_1^\dagger, \beta_2^\dagger)$，使$H(\beta^\dagger) = Y - \beta_1^\dagger A - \beta_2^\dagger A V$满足：
    $$
    \alpha_1 = \alpha_2 = 0 \quad \text{in} \quad \text{logit Pr}[A=1 | H(\beta^\dagger), V, L] = \alpha_0 + \alpha_1 H(\beta^\dagger) + \alpha_2 H(\beta^\dagger) V + \alpha_3 L
    $$
  - 线性SNMM有闭式解（见技术点14.2）；非线性模型需用优化算法。
- **技术点14.2**：G估计的估计方程：
  $$
  \sum_{i=1}^n I[C_i=0] W_i^C H_i(\beta^\dagger) (A_i - E[A|L_i]) q(L_i) = 0
  $$
  - 若指定$E[H(\beta^\dagger)|L]$，可得双稳健估计量。

### 结论
1. **G估计的核心**：通过反事实结果$Y^{a=0}$与处理$A$的条件独立性（给定$L$）估计SNMM参数。
2. **适用场景**：适用于时不变处理，需IP权重调整删失偏倚。
3. **优势**：
   - 半参数性质：不指定$E[Y^{a=0}|L]$，较参数g公式更稳健。
   - 可扩展至未测量混杂的敏感性分析。
4. **局限**：
   - 忽略效应修饰时SNMM会错误指定。
   - 高维参数搜索计算复杂（但线性模型有闭式解）。
5. **与其他方法关系**：
   - 区别于MSM（估计总体或$V$-条件效应），SNMM估计$L$-条件效应。
   - 与标准化、IP加权并称"g-methods"。

> 所有技术术语（如g-methods, SNMM, rank preservation）保留英文，确保准确性。
</think>
### 第14章总结：结构嵌套模型的G估计

#### **章节逻辑结构**
1. **14.1 因果问题回顾**  
   - 目标：估计戒烟（处理 \(A\)）对体重增加（结果 \(Y\)) 的条件平均因果效应 \(E[Y^{a=1,c=0}|L] - E[Y^{a=0,c=0}|L]\)，其中 \(L\) 为混杂变量（性别、年龄、种族等）。  
   - 子群体分析：可通过边际结构模型（含乘积项）或标准化方法估计特定子群（如年龄=45）的效应。  
   - 数据：NHEFS 观测数据（\(n=1566\)），调整混杂和删失（\(C=0\) 表示未失访）。

2. **14.2 可交换性再探**  
   - **核心定义**：条件可交换性 \(Y^a \perp\!\!\!\perp A \mid L\) 等价于：  
     \[
     \Pr[A=1 \mid Y^{a=0}, L] = \Pr[A=1 \mid L]
     \]
   - **Logistic 模型**：  
     \[
     \text{logit} \Pr[A=1 \mid Y^{a=0}, L] = \alpha_0 + \alpha_1 Y^{a=0} + \alpha_2 L
     \]
     若可交换性成立，则 \(\alpha_1 = 0\)（反事实 \(Y^{a=0}\) 不预测处理分配 \(A\)）。

3. **14.3 结构嵌套均值模型（SNMM）**  
   - **模型形式**：  
     \[
     E[Y^a - Y^{a=0} \mid A=a, L] = \beta_1 a + \beta_2 a L
     \]
     - \(\beta_1, \beta_2\) 量化 \(A\) 对 \(Y\) 在 \((A,L)\) 层内的平均因果效应。  
     - **半参数特性**：不指定截距 \(\beta_0\) 和 \(L\) 的主效应 \(\beta_3 L\)，较参数化 g-公式更稳健。  
   - **删失调整**：  
     - G 估计仅处理混杂，需先用 IP 权重 \(W^C = 1/\Pr[C=0 \mid L,A]\) 调整删失偏倚（创建伪总体）。  
   - **精细点 14.1**：  
     - 半参数边际结构模型 \(E[Y^a - Y^{a=0} \mid V] = \beta_1 a + \beta_2 a V\) 与 SNMM 等价（当 \(V \subset L\) 时）。  
   - **技术点 14.1**：  
     - 乘性 SNMM（用于正值结局）：  
       \[
       \log \left( \frac{E[Y^a \mid A=a, L]}{E[Y^{a=0} \mid A=a, L]} \right) = \beta_1 a + \beta_2 a L
       \]

4. **14.4 秩保持**  
   - **秩保持模型**：  
     \[
     Y_i^a - Y_i^{a=0} = \psi_1 a + \psi_2 a L_i \quad (\forall i)
     \]
     - 假设个体因果效应在 \(L\) 层内恒定（如戒烟使所有人增重 \(\psi_1 + \psi_2 L_i\) kg）。  
   - **非现实性**：个体效应存在异质性（如图 14.3），但引入以简化 G 估计理解。  
   - **关键点**：SNMM 本身不要求秩保持，仅估计层内平均因果效应。

5. **14.5 G估计**  
   - **步骤**：  
     1. 构建候选反事实 \(H(\psi^\dagger) = Y - \psi^\dagger A\)（基于秩保持模型 \(Y^{a=0} = Y - \psi_1 A\)）。  
     2. 搜索 \(\psi^\dagger\) 使得 \(H(\psi^\dagger)\) 与 \(A\) 独立（给定 \(L\)）：  
        \[
        \text{logit} \Pr[A=1 \mid H(\psi^\dagger), L] = \alpha_0 + \alpha_1 H(\psi^\dagger) + \alpha_2 L
        \]
        解 \(\alpha_1 = 0\) 的 \(\psi^\dagger\) 即为估计 \(\hat{\psi}_1\)。  
     3. **删失调整**：仅对未删失个体（\(C=0\)）分析，权重为 \(W^C\)。  
   - **置信区间**：  
     - 反转检验：95% CI 为满足 \(\alpha_1 = 0\) 的检验 \(p>0.05\) 的 \(\psi^\dagger\) 集合。  
     - 保守性：因使用 IP 权重，大样本下置信水平 \(\geq 95\%\)。  
   - **精细点 14.2**：  
     - 未测量混杂敏感性分析：若可交换性不成立（\(\alpha_1 \neq 0\)），可假设 \(\alpha_1\) 取值并重复 G 估计。  

6. **14.6 多参数 SNMM**  
   - **模型扩展**：  
     \[
     E[Y^a - Y^{a=0} \mid A=a, L] = \beta_1 a + \beta_2 a V \quad (V \subset L)
     \]
   - **G 估计**：  
     - 搜索 \((\beta_1^\dagger, \beta_2^\dagger)\) 使 \(H(\beta^\dagger) = Y - \beta_1^\dagger A - \beta_2^\dagger A V\) 满足：  
       \[
       \alpha_1 = \alpha_2 = 0 \quad \text{in} \quad \text{logit} \Pr[A=1 \mid H(\beta^\dagger), V, L]
       \]
     - **闭式解**：线性 SNMM 可通过估计方程直接求解（技术点 14.2）。  
   - **模型误指定风险**：若忽略效应修饰（如未包含 \(\beta_2 a V\)），估计有偏。  

---

#### **技术点 14.2：G 估计的估计方程**
- **估计方程**：  
  \[
  \sum_{i=1}^n I[C_i=0] W_i^C H_i(\beta^\dagger) (A_i - E[A \mid L_i]) q(L_i) = 0
  \]
  - \(H_i(\beta^\dagger) = Y_i - A_i \gamma(L_i; \beta^\dagger)\)，\(\gamma(L; \beta^\dagger)\) 为 SNMM 指定函数。  
  - \(q(L_i)\) 为用户指定函数（影响效率但不影响一致性）。  
- **双稳健性**：若指定 \(E[H(\beta^\dagger) \mid L]\) 或同时正确指定 \(E[A \mid L]\) 和 \(\Pr[C=0 \mid A,L]\)，则估计一致。  

---

### **结论**
1. **G 估计原理**：利用反事实结果 \(Y^{a=0}\) 与处理 \(A\) 的条件独立性（给定 \(L\)）估计 SNMM 参数，核心为求解 \(\alpha_1 = 0\)。  
2. **优势**：  
   - 半参数特性：不建模 \(E[Y^{a=0} \mid L]\)，较参数方法更稳健。  
   - 可处理连续处理和多参数模型。  
   - 支持未测量混杂的敏感性分析。  
3. **局限**：  
   - 需 IP 权重调整删失偏倚。  
   - 忽略效应修饰时模型易误指定。  
4. **与其他方法关系**：  
   - 与 IP 加权、标准化并称 **g-methods**。  
   - SNMM 估计 \(L\)-条件效应，而边际结构模型估计总体或 \(V\)-条件效应。  

> 所有技术术语（如 g-methods, SNMM, rank preservation）保留英文以确保准确性，数学公式按标准 LaTeX 格式呈现。