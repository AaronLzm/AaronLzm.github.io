---
title: Chapter_17
category: Causal inference
tags: [DeepSeek-R1-0528-1st,response_md]

---
<think>
我们正在处理《因果推断：What If》第17章“因果生存分析”的内容。本章主要讨论在存在行政删失（administrative censoring）的情况下，如何估计处理对事件发生时间的因果效应。以下是本章各子章节的核心内容总结，包括所有技术要点和细节要点，并保留关键术语的英文表述。

### 17.1 风险与危险 (Hazards and risks)
- **生存分析定义**：研究处理对事件发生时间（如死亡、结婚、入狱等）的影响，事件不限于死亡。
- **行政删失**：研究结束时部分个体尚未发生事件，导致其生存时间未知（仅知大于研究结束时间）。
- **关键指标**：
  - **生存概率 (Survival probability)**：$Pr[T > k]$，个体在时间 $k$ 前未发生事件的比例。
  - **风险 (Risk, Cumulative incidence)**：$Pr[T \leq k] = 1 - Pr[T > k]$，时间 $k$ 前发生事件的累积概率。
  - **危险 (Hazard)**：$Pr[T = k | T > k-1]$，在时间 $k-1$ 未发生事件的个体中，时间 $k$ 发生事件的比例（离散时间风险）。
- **生存曲线与风险曲线**：生存曲线单调下降，风险曲线单调上升。
- **危险比 (Hazard ratio) 的问题**：
  - 随时间变化，常被加权平均后报告（如Cox模型），难以解释。
  - 因 conditioning on a post-treatment variable（存活至时间 $k$）可能引入选择偏倚（见图17.3）。

### 17.2 从危险到风险 (From hazards to risks)
- **数据格式**：
  - **宽格式 (Wide format)**：每行代表一个个体。
  - **人时格式 (Person-time format)**：每行代表一个个体在一个时间点的状态（如每月一行）。
- **定义事件指标**：$D_k = I(T \leq k)$，当 $T \leq k$ 时取1，否则取0。
- **生存概率计算**：
  $$
  Pr[D_k = 0] = \prod_{m=1}^{k} Pr[D_m = 0 | D_{m-1} = 0] = \prod_{m=1}^{k} (1 - \lambda_m)
  $$
  其中 $\lambda_m = Pr[D_m = 1 | D_{m-1} = 0]$ 是 $m$ 时刻的危险。
- **估计方法**：
  - **非参数**：Kaplan-Meier 估计量（乘积极限估计）。
  - **参数模型**：拟合逻辑回归模型估计危险，例如：
    $$
    \text{logit } Pr[D_{k+1} = 1 | D_k = 0, A] = \theta_{0,k} + \theta_1 A + \theta_2 A \times k + \theta_3 A \times k^2
    $$
    其中 $\theta_{0,k}$ 是时间变化的截距项（如 $\theta_0 + \theta_4 k + \theta_5 k^2$）。

### 17.3 删失为何重要 (Why censoring matters)
- **随机进入研究 (Staggered entry)**：个体进入研究时间不同，导致行政删失时间 $k_{\text{end}}$ 不同。
- **定义删失指标**：$C_k = I(\text{administrative end} \leq k)$。
- **正确估计生存概率**：需考虑删失，在无随机删失假设下：
  $$
  Pr[D_k = 0 | A = a] = \prod_{m=1}^{k} Pr[D_m = 0 | D_{m-1} = 0, C_m = 0, A = a]
  $$
- **忽略删失机制偏差**：仅使用未删失个体计算生存概率会导致选择偏倚（如当处理影响生存时间时）。

### 17.4 边际结构模型的IP加权 (IP weighting of marginal structural models)
- **目标**：估计反事实生存曲线 $Pr[D^{a}_{k+1} = 0]$（$a=1$ 和 $a=0$）。
- **假设**：可交换性 (exchangeability)、一致性 (consistency)、正性 (positivity)。
- **步骤**：
  1. **估计IP权重**：
     - 拟合处理模型 $Pr[A=1 | L]$，计算稳定权重 $SW^A = \frac{Pr[A=1]}{Pr[A=1 | L]}$（当 $A=1$）或 $\frac{1 - Pr[A=1]}{1 - Pr[A=1 | L]}$（当 $A=0$）。
  2. **加权拟合危险模型**：用人时数据拟合加权逻辑模型：
     $$
     \text{logit } Pr[D_{k+1} = 1 | D_k = 0, A] = \beta_{0,k} + \beta_1 a + \beta_2 a \times k + \beta_3 a \times k^2
     $$
  3. **计算生存曲线**：将估计的危险代入生存概率乘积公式。
- **应用示例**：戒烟对死亡率影响（NHEFS数据），调整后120个月生存率差异不显著（80.7% vs 80.5%）。

### 17.5 参数化g公式 (The parametric g-formula)
- **目标**：同IP加权，但使用标准化 (standardization)。
- **公式**：
  $$
  Pr[D^{a}_{k+1} = 0] = \sum_l Pr[D_{k+1} = 0 | L = l, A = a] Pr[L = l]
  $$
- **步骤**：
  1. **估计条件危险**：拟合含协变量 $L$ 的危险模型（如逻辑回归）。
  2. **预测条件生存概率**：计算 $Pr[D_{k+1} = 0 | L = l, A = a]$。
  3. **标准化**：对 $l$ 求平均（通过扩展数据集、预测和平均）。
- **应用示例**：结果与IP加权类似（120个月生存率80.4% vs 80.6%）。

### 17.6 结构嵌套模型的G估计 (G-estimation of structural nested models)
- **挑战**：结构嵌套模型直接建模因果对比（如风险比），而非生存概率本身。
- **加速失效时间模型 (Accelerated failure time model, AFT)**：
  - 定义：$T^a_i / T^{0}_i = \exp(-\psi_1 a - \psi_2 a L_i)$，其中 $\psi_1 < 0$ 表示处理延长生存时间。
  - **秩保持问题**：模型是确定性和秩保持的（不现实），但G估计可推广到非秩保持模型。
- **G估计步骤**：
  1. **构造反事实生存时间**：$H_i(\psi^\dagger) = T_i \exp(\psi^\dagger A_i)$。
  2. **人工删失 (Artificial censoring)**：排除那些在反事实处理下会被删失的个体（定义 $\Delta(\psi)$ 指标）。
  3. **估计方程**：寻找 $\psi$ 使得 $\Delta(\psi)$ 与 $A$ 在给定 $L$ 下独立。
- **应用示例**：戒烟对生存时间比率的点估计为1.05（95% CI: 0.77-1.25），无显著效应。

### 结论
- **生存分析核心问题**：处理行政删失，使用危险、生存概率、风险等指标。
- **因果推断方法**：IP加权、g公式、G估计均可用于调整混杂，但需不同建模假设。
- **方法选择**：
  - IP加权和g公式更直观（直接估计生存曲线），但需正确指定模型。
  - G估计（AFT模型）更贴近生物学机制，但计算复杂且应用较少。
- **关键挑战**：竞争风险（Fine Point 17.1）和时变处理（Part III讨论）需额外考虑。

### 数学公式汇总
1. **生存概率**：$Pr[D_k = 0] = \prod_{m=1}^{k} (1 - \lambda_m)$
2. **AFT模型**：$T^{0}_i = T_i \exp(\psi_1 A_i + \psi_2 A_i L_i)$
3. **IP加权危险模型**：$\text{logit } \lambda = \beta_{0,k} + \beta_1 a + \beta_2 a k + \beta_3 a k^2$

本章强调在生存分析中避免对危险比的过度依赖，推荐使用生存/风险差异作为效应量，并详细讨论了各方法在删失数据下的实现。
</think>
### 第17章：因果生存分析（Causal Survival Analysis）总结

#### **17.1 风险与危险（Hazards and Risks）**
- **核心问题**：估计处理（如戒烟）对事件发生时间（如死亡时间）的因果效应，考虑行政删失（administrative censoring）。
- **关键概念**：
  - **行政删失**：研究结束时部分个体未发生事件，其生存时间未知（仅知 > 研究结束时间）。
  - **生存概率（Survival Probability）**：$Pr[T > k]$，个体在时间 $k$ 前未发生事件的比例。
  - **风险（Risk/Cumulative Incidence）**：$Pr[T \leq k] = 1 - Pr[T > k]$，时间 $k$ 前发生事件的累积概率。
  - **危险（Hazard）**：$Pr[T = k | T > k-1]$，在时间 $k-1$ 存活者中，$k$ 时发生事件的概率（离散时间）。
- **危险比（Hazard Ratio）的局限性**：
  - 随时间变化，常被加权平均报告（如Cox模型），解释困难。
  - 因"conditioning on a post-treatment variable"（如存活至时间 $k$）可能引入选择偏倚（见图17.3）。

#### **17.2 从危险到风险（From Hazards to Risks）**
- **数据格式**：
  - **宽格式（Wide）**：每行代表一个个体。
  - **人时格式（Person-time）**：每行代表一个个体在一个时间点的状态（如每月一行）。
- **事件指标**：$D_k = I(T \leq k)$，$T \leq k$ 时取1，否则取0。
- **生存概率计算**：
  $$
  Pr[D_k = 0] = \prod_{m=1}^{k} Pr[D_m = 0 | D_{m-1} = 0] = \prod_{m=1}^{k} (1 - \lambda_m)
  $$
  其中 $\lambda_m = Pr[D_m = 1 | D_{m-1} = 0]$ 为 $m$ 时刻危险。
- **估计方法**：
  - **非参数**：Kaplan-Meier 估计量（乘积极限估计）。
  - **参数模型**：逻辑回归拟合危险，例如：
    $$
    \text{logit } Pr[D_{k+1} = 1 | D_k = 0, A] = \theta_{0,k} + \theta_1 A + \theta_2 A \times k + \theta_3 A \times k^2
    $$
    $\theta_{0,k}$ 为时间相关截距（如 $\theta_0 + \theta_4 k + \theta_5 k^2$）。

#### **17.3 删失的重要性（Why Censoring Matters）**
- **随机进入研究（Staggered Entry）**：个体进入时间不同导致行政删失时间 $k_{\text{end}}$ 不同。
- **删失指标**：$C_k = I(\text{行政结束时间} \leq k)$。
- **正确估计生存概率**：在无随机删失假设下：
  $$
  Pr[D_k = 0 | A = a] = \prod_{m=1}^{k} Pr[D_m = 0 | D_{m-1} = 0, C_m = 0, A = a]
  $$
- **忽略删失的偏倚**：仅用未删失个体计算生存概率会导致选择偏倚（当处理影响生存时间时）。

#### **17.4 边际结构模型的IP加权（IP Weighting of MSMs）**
- **目标**：估计反事实生存曲线 $Pr[D^{a}_{k+1} = 0]$（$a=1$ 和 $a=0$）。
- **假设**：可交换性（exchangeability）、一致性（consistency）、正性（positivity）。
- **步骤**：
  1. **估计IP权重**：
     - 拟合处理模型 $Pr[A=1 | L]$，计算稳定权重 $SW^A = \frac{Pr[A=1]}{f(A|L)}$。
  2. **加权拟合危险模型**：用人时数据拟合加权逻辑模型：
     $$
     \text{logit } Pr[D_{k+1} = 1 | D_k = 0, A] = \beta_{0,k} + \beta_1 a + \beta_2 a \times k + \beta_3 a \times k^2
     $$
  3. **计算生存曲线**：将估计危险代入生存概率乘积公式。
- **应用示例**：戒烟对死亡率影响（NHEFS数据），调整后120个月生存率差异不显著（80.7% vs 80.5%）。

#### **17.5 参数化g公式（Parametric g-Formula）**
- **公式**：
  $$
  Pr[D^{a}_{k+1} = 0] = \sum_l Pr[D_{k+1} = 0 | L = l, A = a] Pr[L = l]
  $$
- **步骤**：
  1. **估计条件危险**：拟合含协变量 $L$ 的危险模型（如逻辑回归）。
  2. **预测条件生存概率**：计算 $Pr[D_{k+1} = 0 | L = l, A = a]$。
  3. **标准化**：对 $l$ 求平均（通过扩展数据集、预测和平均）。
- **应用示例**：结果与IP加权类似（120个月生存率80.4% vs 80.6%）。

#### **17.6 结构嵌套模型的G估计（G-Estimation of SNMs）**
- **加速失效时间模型（AFT）**：
  - 定义：$T^{0}_i = T_i \exp(\psi_1 A_i + \psi_2 A_i L_i)$，$\psi_1 < 0$ 表示处理延长生存时间。
  - **秩保持问题**：模型为确定性和秩保持（不现实），但G估计可推广至非秩保持模型。
- **G估计步骤**：
  1. **构造反事实生存时间**：$H_i(\psi^\dagger) = T_i \exp(\psi^\dagger A_i)$。
  2. **人工删失（Artificial Censoring）**：排除反事实处理下会被删失的个体（定义 $\Delta(\psi)$ 指标）。
  3. **估计方程**：寻找 $\psi$ 使 $\Delta(\psi)$ 与 $A$ 在给定 $L$ 下独立。
- **应用示例**：生存时间比率点估计为1.05（95% CI: 0.77-1.25），无显著效应。

---

### **结论**
1. **生存分析核心**：处理行政删失，使用生存概率、风险、危险等指标，避免依赖危险比。
2. **因果推断方法**：
   - **IP加权**：通过权重调整混杂，需正确指定处理模型和危险模型。
   - **g公式**：直接标准化，需正确指定条件危险模型。
   - **G估计（AFT）**：建模生存时间比率，计算复杂但更贴近机制解释。
3. **关键挑战**：
   - **竞争风险（Competing Risks）**：需谨慎处理（如Fine Point 17.1）。
   - **时变处理**：需扩展至Part III的时变模型。
4. **实际应用**：戒烟对10年生存率无显著影响（调整后差异<2%），各方法结果一致。

### **公式汇总**
| **概念** | **公式** |
|----------|----------|
| 生存概率 | $Pr[D_k = 0] = \prod_{m=1}^{k} (1 - \lambda_m)$ |
| AFT模型 | $T^{0}_i = T_i \exp(\psi_1 A_i + \psi_2 A_i L_i)$ |
| IP加权危险模型 | $\text{logit } \lambda = \beta_{0,k} + \beta_1 a + \beta_2 a k + \beta_3 a k^2$ |

> 本总结严格遵循原文技术细节，未引入主观推断，确保信息完整性与准确性。