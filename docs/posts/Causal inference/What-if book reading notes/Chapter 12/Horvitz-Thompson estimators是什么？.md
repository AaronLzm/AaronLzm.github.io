---
title: Horvitz-Thompson estimators是什么？
category: Causal inference
tags: [Chapter 12,What-if book reading notes]

---
**Horvitz-Thompson (HT) 估计量**是抽样调查与因果推断中的核心估计方法，用于解决**基于不等概率抽样或存在混杂时的总体均值估计**问题。其核心思想是通过**逆概率加权（Inverse Probability Weighting, IPW）**校正选择偏差或混杂偏倚。以下是关键要点解析：

---

### **一、基本定义与公式**
#### **1. 基础形式**
- 对于总体中个体 \(i\) 的观测值 \(Y_i\) 和处理 \(A_i\)，HT 估计量定义为：
  \[
  \hat{\mu}_{a}^{\text{HT}} = \frac{1}{n} \sum_{i=1}^{n} \frac{I(A_i = a) \cdot Y_i}{f(A_i = a | L_i)}
  \]
  - \(I(A_i = a)\)：指示函数（当个体 \(i\) 接受处理 \(a\) 时为 1，否则为 0）。
  - \(f(A_i = a | L_i)\)：倾向性评分（给定协变量 \(L_i\) 下接受处理 \(a\) 的概率）。

#### **2. 目标**
- 估计**反事实均值** \(E[Y^a]\)（若所有个体强制接受处理 \(a\) 的潜在结果均值）。
- 需满足假设：**可交换性**（\(Y^a \perp A \mid L\)）、**正性**（\(0 < f(A=a \mid L) < 1\)）、**一致性**（\(A=a\) 时 \(Y = Y^a\)）。

---

### **二、为何需要改进为 Hajek 估计量？**
#### **问题 1：极端权重放大方差**
- 若 \(f(A=a \mid L_i) \approx 0\)（倾向性评分接近 0），权重 \(\frac{1}{f(A=a \mid L_i)}\) 极大 → 估计量方差爆炸式增长。
- **例**：在戒烟研究中，66 岁白人女性的 \(\text{Pr}(A=1 \mid L) \approx 0\)，权重可能达 100+ 倍。

#### **问题 2：不保证估计值在合理范围**
- 对二值结局 \(Y \in \{0,1\}\)，HT 估计值可能超出 \([0,1]\) 范围（不符合概率性质）。

#### **解决方案：Hajek 估计量**
\[
\hat{\mu}_{a}^{\text{Hajek}} = \frac{ \sum_{i=1}^{n} \frac{I(A_i = a) \cdot Y_i}{f(A_i = a | L_i)} }{ \sum_{i=1}^{n} \frac{I(A_i = a)}{f(A_i = a | L_i)} }
\]
- **分子**：HT 估计量的分子（加权观测结果之和）。
- **分母**：加权处理指示函数之和（估计伪总体中接受处理 \(a\) 的比例）。

---

### **三、Hajek 估计量的优势**
| **性质**          | **Horvitz-Thompson** | **Hajek**              |
|-------------------|-----------------------|------------------------|
| **无偏性**        | 渐近无偏              | 渐近无偏                |
| **方差**          | 可能极大              | 更小（抑制极端权重影响）|
| **取值范围**      | 可能超出 \([0,1]\)    | 保证在 \([0,1]\) 内     |
| **实际应用频率**  | 少                    | 多（如 MSM 的加权回归）|

---

### **四、与边际结构模型（MSM）的关系**
在因果推断中，Hajek 估计量等价于 **MSM 的加权最小二乘估计**：
1. **模型设定**：饱和 MSM \(E[Y^a] = \beta_0 + \beta_1 a\)。
2. **加权回归**：
   - 用权重 \(W_i = \frac{1}{f(A_i \mid L_i)}\) 拟合线性模型 \(E[Y \mid A] = \theta_0 + \theta_1 A\)。
   - 所得 \(\hat{\theta}_1\) 即为 \(\hat{\mu}_{1}^{\text{Hajek}} - \hat{\mu}_{0}^{\text{Hajek}}\)（因果效应估计）。

---

### **五、非正性（Nonpositivity）下的修正**
当存在 **结构性非正性**（某些 \(L=l\) 下 \(f(A=a \mid L=l)=0\)）时：
- HT 估计量 → 估计 \(E[Y^a \mid L \in Q(a)]\)（\(Q(a) = \{l: f(A=a \mid L=l)>0\}\) 的子群体）。
- Hajek 估计量 → 估计 \(E[Y^a \mid L \in Q(a)] \cdot \text{Pr}[Q(a)]\)（需额外校正）。

---

### **六、实例说明（NHEFS 戒烟研究）**
- **原始 HT 估计**：直接加权观测增重 \(Y_i\)，权重 \(W_i = 1 / \text{Pr}(A_i \mid L_i)\)。
- **问题**：权重范围 1.05–16.7 → 高方差。
- **Hajek 解决方案**：
  - 拟合 MSM：\(E[Y \mid A] = \theta_0 + \theta_1 A\)，权重 \(W_i = SW_i\)（稳定权重）。
  - 估计 ACE：\(\hat{\theta}_1 = 3.4\) kg（95% CI: 2.4–4.5）。

---

### **关键结论**
- **Horvitz-Thompson** 是 IPW 的理论基础，但因极端权重问题**实际很少直接使用**。
- **Hajek 估计量**是其改进版，通过标准化分母控制方差，是 **MSM 和 IPW 实践的核心**。
- 在因果推断中，Hajek 估计量等价于 **加权最小二乘**，用于估计边际结构模型参数。